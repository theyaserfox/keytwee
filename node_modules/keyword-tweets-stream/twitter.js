//Load the http module
var https = require("https");
var oauth = require('oauth');

//Get the tweets stream
function getTweetsStream(keyword, callback) {
	//Twitter api urls
	var filter_stream_url = 'https://stream.twitter.com/1.1/statuses/filter.json?track=' + keyword,
    	request_token_url = 'https://api.twitter.com/oauth/request_token',
    	access_token_url = 'https://api.twitter.com/oauth/access_token';

	this.oauth = new oauth.OAuth(
        request_token_url,
        access_token_url,
        'Scz0rYVE6std7725VYFhKtqDo',
        'LzftandOIMicMxei2Quv6OOqmmPTafTqJ8aaAmV4UhPq8maWLb',
        '1.0',
        null,
        'HMAC-SHA1',
        null,
        {
          'Accept': '*/*',
          'Connection'
          : 'close',
          'User-Agent': 'theyoyofox'
        }
    );

    var request = this.oauth.post(
        filter_stream_url,
        '2713892300-nl4a5qpxs0bNNE1hXzTY46Xdmu6RbC3oqancFVa',
        'QKgddx595YUKuWnFABnTIBLYeJ1rgK8kLkzQ9pmtLlSLH',
        null
    );

    request.on('response', function(response) {
    	//set chunk encoding
        response.setEncoding('utf8');

  		var fullChunk = '';

    	response.on("data", function(chunk){
    		var data = chunk.toString();

     		if (this._lastLineData) data = this._lastLineData + data;
 
     		var lines = data.split('\n');

     		this._lastLineData = lines.splice(lines.length-1,1)[0];

     		var last_char = data.slice(-3);

     		if(last_char[0] == '}') {
     			var clean_data = data.substr(0,data.length-2);

     			var tweet = JSON.parse(clean_data);

    			callback(tweet.text);
    		}
		});

		response.on("end", function(){
			console.log("Disconnected");
		});

		response.on("error", function(error){
			console.log("ERROR: " + error.message);
		});
    });

	request.on("error", function(error) {
		console.log("ERROR: " + error.message);
	});

	request.end();
}

//Export api functions for the module
module.exports.getTweetsStream = getTweetsStream;